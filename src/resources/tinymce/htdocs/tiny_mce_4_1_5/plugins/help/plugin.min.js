tinymce.PluginManager.add("help",function(e){function t(e,t){function r(e,r){if(n.parentNode){n.parentNode.removeChild(n)}t({width:e,height:r})}var n=document.createElement("img");n.onload=function(){r(n.clientWidth,n.clientHeight)};n.onerror=function(){r()};var i=n.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(n);n.src=e}function n(e,t,n){function r(e,n){n=n||[];tinymce.each(e,function(e){var i={text:e.text||e.title};if(e.menu){i.menu=r(e.menu)}else{i.value=e.value;t(i)}n.push(i)});return n}return r(e,n||[])}function r(t){return function(){var n=e.settings.help_list;if(typeof n=="string"){tinymce.util.XHR.send({url:n,success:function(e){t(tinymce.util.JSON.parse(e))}})}else if(typeof n=="function"){n(t)}else{t(n)}}}function i(r){function p(){var e,t,n,r;e=i.find("#width")[0];t=i.find("#height")[0];if(!e||!t){return}n=e.value();r=t.value();if(i.find("#constrain")[0].checked()&&a&&f&&n&&r){if(a!=n){r=Math.round(n/a*r);t.value(r)}else{n=Math.round(r/f*n);e.value(n)}}a=n;f=r}function d(){function t(t){function n(){t.onload=t.onerror=null;if(e.selection){e.selection.select(t);e.nodeChanged()}}t.onload=function(){if(!s.width&&!s.height&&h){o.setAttribs(t,{width:t.clientWidth,height:t.clientHeight})}n()};t.onerror=n}y();p();s=tinymce.extend(s,i.toJSON());if(!s.alt){s.alt=""}if(s.width===""){s.width=null}if(s.height===""){s.height=null}if(!s.style){s.style=null}s={src:s.src,alt:s.alt,width:s.width,height:s.height,style:s.style,"class":s["class"]};e.undoManager.transact(function(){if(!s.src){if(u){o.remove(u);e.focus();e.nodeChanged()}return}if(!u){s.id="__mcenew";e.focus();e.selection.setContent(o.createHTML("img",s));u=o.get("__mcenew");o.setAttrib(u,"id",null)}else{o.setAttribs(u,s)}t(u)})}function v(e){if(e){e=e.replace(/px$/,"")}return e}function m(n){var r=n.meta||{};if(l){l.value(e.convertURL(this.value(),"src"))}tinymce.each(r,function(e,t){i.find("#"+t).value(e)});if(!r.width&&!r.height){t(this.value(),function(e){if(e.width&&e.height&&h){a=e.width;f=e.height;i.find("#width").value(a);i.find("#height").value(f)}})}}function y(){function t(e){if(e.length>0&&/^[0-9]+$/.test(e)){e+="px"}return e}if(!e.settings.help_advtab){return}var n=i.toJSON();var r=o.parseStyle(n.style);delete r.margin;r["margin-top"]=r["margin-bottom"]=t(n.vspace);r["margin-left"]=r["margin-right"]=t(n.hspace);r["border-width"]=t(n.border);i.find("#style").value(o.serializeStyle(o.parseStyle(o.serializeStyle(r))))}var i,s={},o=e.dom,u=e.selection.getNode();var a,f,l,c,h=e.settings.help_dimensions!==false;a=o.getAttrib(u,"width");f=o.getAttrib(u,"height");if(u.nodeName=="IMG"&&!u.getAttribute("data-mce-object")&&!u.getAttribute("data-mce-placeholder")){s={src:o.getAttrib(u,"src"),alt:o.getAttrib(u,"alt"),"class":o.getAttrib(u,"class"),width:a,height:f}}else{u=null}if(r){l={type:"listbox",label:"Image list",values:n(r,function(t){t.value=e.convertURL(t.value||t.url,"src")},[{text:"None",value:""}]),value:s.src&&e.convertURL(s.src,"src"),onselect:function(e){var t=i.find("#alt");if(!t.value()||e.lastControl&&t.value()==e.lastControl.text()){t.value(e.control.text())}i.find("#src").value(e.control.value()).fire("change")},onPostRender:function(){l=this}}}if(e.settings.help_class_list){c={name:"class",type:"listbox",label:"Class",values:n(e.settings.help_class_list,function(t){if(t.value){t.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[t.value]})}}})}}var g=[{name:"src",type:"filepicker",filetype:"help",label:"Source",autofocus:true,onchange:m},l];if(e.settings.help_description!==false){g.push({name:"alt",type:"textbox",label:"Image description"})}if(h){g.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:p,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:p,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}g.push(c);if(e.settings.help_advtab){if(u){s.hspace=v(u.style.marginLeft||u.style.marginRight);s.vspace=v(u.style.marginTop||u.style.marginBottom);s.border=v(u.style.borderWidth);s.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(u,"style")))}i=e.windowManager.open({title:"SUGUSInsert/edit help",data:s,bodyType:"tabpanel",body:[{title:"General",type:"form",items:g},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:y},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:d})}else{i=e.windowManager.open({title:"Hilfe / Help",data:s,body:g,onSubmit:d})}}e.addButton("help",{icon:"help",tooltip:"Help",onclick:r(i),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});e.addMenuItem("help",{icon:"help",text:"POINTInsert help",onclick:r(i),context:"insert",prependToContext:true});e.addCommand("mceImage",r(i))})
